# Nginx sidecar to bypass MCP SDK DNS rebinding protection.
#
# The MCP Python SDK's TransportSecurityMiddleware validates the Host header
# and rejects anything that isn't localhost or 127.0.0.1 (HTTP 421).
# This proxy rewrites the Host header to localhost before forwarding to MindsDB,
# making the MCP SSE endpoint accessible from Docker service hostnames.
#
# See: GitHub Issue #12089 (MindsDB), MCP SDK PR #861

server {
    listen 47336;

    location /mcp/ {
        proxy_pass http://mindsdb:47334/mcp/;
        proxy_set_header Host localhost;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_http_version 1.1;

        # SSE-specific: disable buffering and keep connection alive
        proxy_set_header Connection '';
        proxy_buffering off;
        proxy_cache off;
        chunked_transfer_encoding off;

        # SSE connections can be long-lived
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }
}
