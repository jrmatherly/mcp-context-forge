# ===============================================================
# üï∏Ô∏è  Web Lint & Static Analysis - Frontend Code Quality Gate
# ===============================================================
# Authors: Mihai Criveti
#   - runs each web linter in its own matrix job for visibility
#   - mirrors the actual CLI commands used locally (no `make`)
#   - ensures fast-failure isolation: one failure doesn't hide others
#   - installs tools per-job without package.json
#   - logs are grouped and plain-text for readability
# ---------------------------------------------------------------

name: Web Lint & Static Analysis

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  lint-web:
    strategy:
      fail-fast: false
      matrix:
        include:
          # -------------------------------------------------------
          # üßº HTML/CSS/JS Linters & Validators
          # -------------------------------------------------------
          - id: htmlhint
            cmd: |
              npm install --no-save --legacy-peer-deps htmlhint
              npx htmlhint "mcpgateway/templates/*.html"

          # -------------------------------------------------------
          # üîí Security Scanners
          # -------------------------------------------------------
          - id: retire
            cmd: |
              npm install --no-save --legacy-peer-deps retire
              npx retire --path mcpgateway/static

          - id: npm-audit
            cmd: |
              if [ ! -f package.json ]; then
                npm init -y >/dev/null
              fi
              npm audit --audit-level=high || true

          # -------------------------------------------------------
          # üîç Additional Code Quality Tools
          # -------------------------------------------------------
          - id: jshint
            cmd: |
              npm install --no-save --legacy-peer-deps jshint
              if [ -f .jshintrc ]; then
                npx jshint --config .jshintrc "mcpgateway/static/*.js"
              else
                npx jshint --esversion=11 "mcpgateway/static/*.js"
              fi

          - id: jscpd
            cmd: |
              npm install --no-save --legacy-peer-deps jscpd
              npx jscpd "mcpgateway/static/" "mcpgateway/templates/"

          # - id: markuplint
          #   cmd: |
          #     npm install --no-save --legacy-peer-deps markuplint
          #     npx markuplint mcpgateway/templates/*

    name: ${{ matrix.id }}
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------------------------------
      # 0Ô∏è‚É£  Checkout
      # -----------------------------------------------------------
      - name: ‚¨áÔ∏è  Checkout source
        uses: actions/checkout@v6.0.2
        with:
          fetch-depth: 1

      # -----------------------------------------------------------
      # 1Ô∏è‚É£  Node.js Setup
      # -----------------------------------------------------------
      - name: üì¶  Set up Node.js
        uses: actions/setup-node@v6.2.0
        with:
          node-version: '20'

      # -----------------------------------------------------------
      # 2Ô∏è‚É£  Run Linter (install and execute in one step)
      # -----------------------------------------------------------
      - name: üîç  Run ${{ matrix.id }}
        run: ${{ matrix.cmd }}

  # -------------------------------------------------------
  # üßπ Biome ‚Äì unified JS/CSS linter & formatter
  # -------------------------------------------------------
  biome:
    name: biome
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v6.0.2
        with:
          fetch-depth: 1

      - name: Set up Biome
        uses: biomejs/setup-biome@v2

      - name: Run Biome check
        run: biome check mcpgateway/static/ tests/js/

  # -------------------------------------------------------
  # üêç Python-based JS Security Scanner (separate job)
  # -------------------------------------------------------
  nodejsscan:
    name: nodejsscan
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------------------------------
      # 0Ô∏è‚É£  Checkout
      # -----------------------------------------------------------
      - name: ‚¨áÔ∏è  Checkout source
        uses: actions/checkout@v6.0.2
        with:
          fetch-depth: 1

      # -----------------------------------------------------------
      # 1Ô∏è‚É£  Python Setup
      # -----------------------------------------------------------
      - name: üêç  Set up Python
        uses: actions/setup-python@v6.2.0
        with:
          python-version: "3.12"
          cache: pip

      # -----------------------------------------------------------
      # 2Ô∏è‚É£  Install nodejsscan
      # -----------------------------------------------------------
      - name: üîß  Install nodejsscan
        run: |
          python3 -m pip install --upgrade pip
          pip install nodejsscan

      # -----------------------------------------------------------
      # 3Ô∏è‚É£  Run nodejsscan
      # -----------------------------------------------------------
      - name: üîí  Run nodejsscan
        run: |
          nodejsscan --directory ./mcpgateway/static
