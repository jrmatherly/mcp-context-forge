# ======================================================================
# ðŸ“¦  Helm Chart - Package & Publish to GHCR OCI
# ======================================================================
#
# Packages the Helm chart and pushes it to GitHub Container Registry
# as an OCI artifact when a GitHub Release is published.
#
# âž¤ Trigger: Release published (e.g. from GitHub UI or `gh release` CLI)
# âž¤ Result:  oci://ghcr.io/OWNER/REPO/mcp-stack:<version>
#
# The chart version is read from Chart.yaml â€” no manual version input
# needed. Ensure Chart.yaml version is bumped before creating a release.
#
# ======================================================================

name: "Helm chart - publish"

# ----------------------------------------------------------------------------
# Trigger: When a release is published (NOT draft or prerelease)
# OR manually via workflow_dispatch
# ----------------------------------------------------------------------------
on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      chart_version_override:
        description: 'Override chart version (leave empty to use Chart.yaml)'
        required: false
        type: string

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io

concurrency:
  group: helm-publish
  cancel-in-progress: false

jobs:
  publish-chart:
    name: package & push
    runs-on: ubuntu-latest

    # ------------------------------------------------------------------
    # Only run if the release tag starts with 'v', and is not draft/prerelease
    # (workflow_dispatch skips this check)
    # ------------------------------------------------------------------
    if: |
      github.event_name == 'workflow_dispatch' ||
      (
        startsWith(github.event.release.tag_name, 'v') &&
        github.event.release.draft == false &&
        github.event.release.prerelease == false
      )

    steps:
      # ----------------------------------------------------------------
      # 0ï¸âƒ£  Checkout
      # ----------------------------------------------------------------
      - name: â¬‡ï¸  Checkout source
        uses: actions/checkout@v6.0.2
        with:
          fetch-depth: 1

      # ----------------------------------------------------------------
      # 1ï¸âƒ£  Install Helm
      # ----------------------------------------------------------------
      - name: âŽˆ  Set up Helm
        uses: azure/setup-helm@v4.3.1
        with:
          version: 'v3.17.3'

      # ----------------------------------------------------------------
      # 2ï¸âƒ£  Lint before publish (safety gate)
      # ----------------------------------------------------------------
      - name: ðŸ”  Helm lint
        run: helm lint charts/mcp-stack/

      # ----------------------------------------------------------------
      # 3ï¸âƒ£  Log in to GHCR
      # ----------------------------------------------------------------
      - name: ðŸ”  Log in to GHCR
        uses: docker/login-action@v3.7.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ----------------------------------------------------------------
      # 4ï¸âƒ£  Extract chart version
      # ----------------------------------------------------------------
      - name: ðŸ·ï¸  Extract chart version
        id: chart
        shell: bash
        env:
          OVERRIDE_VERSION: ${{ inputs.chart_version_override }}
        run: |
          set -euo pipefail
          if [ -n "${OVERRIDE_VERSION}" ]; then
            VERSION=$(echo "${OVERRIDE_VERSION}" | tr -d '[:space:]')
          else
            VERSION=$(grep '^version:' charts/mcp-stack/Chart.yaml | awk '{print $2}' | tr -d '[:space:]')
          fi
          if [ -z "${VERSION}" ]; then
            echo "ERROR: Could not extract version from Chart.yaml" >&2
            exit 1
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Chart version: ${VERSION}"

      # ----------------------------------------------------------------
      # 5ï¸âƒ£  Package chart
      # ----------------------------------------------------------------
      - name: ðŸ“¦  Package Helm chart
        run: |
          helm package charts/mcp-stack/ --destination .helm-packages/
          ls -la .helm-packages/

      # ----------------------------------------------------------------
      # 6ï¸âƒ£  Push to OCI registry
      # ----------------------------------------------------------------
      - name: ðŸš€  Push chart to GHCR OCI
        shell: bash
        env:
          CHART_VERSION: ${{ steps.chart.outputs.version }}
        run: |
          set -euo pipefail
          REPO_LC=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          CHART_PKG=".helm-packages/mcp-stack-${CHART_VERSION}.tgz"

          echo "Pushing ${CHART_PKG} to oci://${REGISTRY}/${REPO_LC}"
          helm push "${CHART_PKG}" "oci://${REGISTRY}/${REPO_LC}"

      # ----------------------------------------------------------------
      # 7ï¸âƒ£  Summary
      # ----------------------------------------------------------------
      - name: ðŸ“‹  Publish summary
        env:
          CHART_VERSION: ${{ steps.chart.outputs.version }}
        run: |
          REPO_LC=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "## Helm Chart Published" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Field | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Chart | mcp-stack |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Version | ${CHART_VERSION} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Registry | oci://${REGISTRY}/${REPO_LC}/mcp-stack |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Install" >> "$GITHUB_STEP_SUMMARY"
          echo '```bash' >> "$GITHUB_STEP_SUMMARY"
          echo "helm install my-release oci://${REGISTRY}/${REPO_LC}/mcp-stack --version ${CHART_VERSION}" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
